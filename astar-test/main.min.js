(function(){tm.define("nz.System",{init:function(){this.$extend({title:"Nineteen",DIRECTION_NUM:{UP:0,UP_RIGHT:1,DOWN_RIGHT:2,DOWN:3,DOWN_LEFT:4,UP_LEFT:5},character:{directions:[{name:"up",rotation:-90,index:0,rotateIndex:[0,1,2,3,-2,-1]},{name:"up_right",rotation:-30,index:1,rotateIndex:[-1,0,1,2,3,-2]},{name:"down_right",rotation:30,index:2,rotateIndex:[-2,-1,0,1,2,3]},{name:"down",rotation:90,index:3,rotateIndex:[3,-2,-1,0,1,2]},{name:"down_left",rotation:150,index:4,rotateIndex:[2,3,-2,-1,0,1]},{name:"up_left",rotation:-150,index:5,rotateIndex:[1,2,3,-2,-1,0]},{name:"default",rotation:90,index:6,rotateIndex:[0,1,2,3,-2,-1]}],action_cost:{rotate:1,attack:2,shot:2}},map:{chip:{width:32,height:32}},screen:{width:640,height:480},dialog:{strokeStyle:"rgba(255,255,255,1.0)",fillStyle:"rgba(128,128,128,1.0)"},assets:{chipdata:"data/chipdata.json",map_object:"img/map_object.png",map_chip:"img/map_chip.png",character_001:{type:"tmss",src:"data/character_001.json"}},MESSAGES:{battle:{position:{setiing:"{name} の開始位置を選択してください。"}}}}),this.ai={}},addAI:function(a,b){return this.ai[a]=b}}),nz.system=nz.System()}).call(this),function(){var a,b,c;a="undefined"!=typeof window&&null!==window?window:global,b=a.nz=null!=(c=a.nz)?c:{},a=void 0,b.Graph=function(){function a(a){var c,d,e,f,g,h,i,j,k,l,m,n;for(null==a&&(a={}),h=a.mapdata,c=a.chipdata,this.nodes=[],this.grid=[],m=e=0,j=h.width;j>=0?j>e:e>j;m=j>=0?++e:--e)this.grid[m]=[];for(n=f=0,k=h.height;k>=0?k>f:f>k;n=k>=0?++f:--f)for(m=g=0,l=h.width;l>=0?l>g:g>l;m=l>=0?++g:--g)(n!==h.height-1||m%2!==0)&&(d=h.data[n][m],i=new b.GridNode(m,n,c[d]),this.grid[m][n]=i,this.nodes.push(i));this.clear()}return a.prototype.clear=function(){var a,b,c,d,e;for(d=this.nodes,e=[],a=0,b=d.length;b>a;a++)c=d[a],c.clean(),e.push(astar.cleanNode(c));return e},a.prototype.cleanDirty=function(){},a.prototype.markDirty=function(a){},a.prototype.neighbors=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p;return n=[],o=a.x,p=a.y,o%2===0?(null!=(null!=(b=this.grid[o])?b[p-1]:void 0)&&n.push(this.grid[o][p-1]),null!=(null!=(f=this.grid[o])?f[p+1]:void 0)&&n.push(this.grid[o][p+1]),null!=(null!=(g=this.grid[o-1])?g[p]:void 0)&&n.push(this.grid[o-1][p]),null!=(null!=(h=this.grid[o-1])?h[p+1]:void 0)&&n.push(this.grid[o-1][p+1]),null!=(null!=(i=this.grid[o+1])?i[p]:void 0)&&n.push(this.grid[o+1][p]),null!=(null!=(j=this.grid[o+1])?j[p+1]:void 0)&&n.push(this.grid[o+1][p+1])):(null!=(null!=(k=this.grid[o])?k[p-1]:void 0)&&n.push(this.grid[o][p-1]),null!=(null!=(l=this.grid[o])?l[p+1]:void 0)&&n.push(this.grid[o][p+1]),null!=(null!=(m=this.grid[o-1])?m[p]:void 0)&&n.push(this.grid[o-1][p]),null!=(null!=(c=this.grid[o-1])?c[p-1]:void 0)&&n.push(this.grid[o-1][p-1]),null!=(null!=(d=this.grid[o+1])?d[p]:void 0)&&n.push(this.grid[o+1][p]),null!=(null!=(e=this.grid[o+1])?e[p-1]:void 0)&&n.push(this.grid[o+1][p-1])),n},a.prototype.toString=function(){var a,b,c,d,e,f,g,h,i;for(a=[],h=this.grid,b=0,d=h.length;d>b;b++){for(g=h[b],i=[],c=0,e=g.length;e>c;c++)f=g[c],i.push(f.weight);a.push(i.join(" "))}return a.join("\n")},a.prototype.searchRoute=function(a,c,d,e,f){var g,h,i,j,k,l,m;for(l=[],m=this.grid[c][d],g=this.grid[e][f],m.direction=a,k=astar.search(this,m,g,{heuristic:b.Graph.heuristic}),h=0,i=k.length;i>h;h++)j=k[h],l.push({mapx:j.x,mapy:j.y,direction:j.direction,cost:j.g});return this.clear(),l},a}(),b.Graph.heuristic=function(a,b){var c,d,e,f,g;return f=Math.abs(a.x-b.x),g=Math.abs(a.y-b.y),e=Math.ceil(f/2),c=a.calcDirectionTo(b),d=a.getDirectionCost(c),g===e?g=0:e>g?0!==g&&(g=1,1===d&&(d=0)):g-=e,f+g+d}}.call(this),function(){var a,b,c;a="undefined"!=typeof window&&null!==window?window:global,b=a.nz=null!=(c=a.nz)?c:{},a=void 0,b.GridNode=function(){function a(a,b,c){null==c&&(c={weight:0}),this.x=a,this.y=b,this.weight=c.weight,this.frame=c.frame,this.name=c.name,this.object=c.object,this.clean()}return a.prototype.clean=function(){this.direction=0},a.prototype.toString=function(){return"["+this.x+","+this.y+"]"},a.prototype.calcDirection=function(a){return b.GridNode.calcDirection(this,a)},a.prototype.calcDirectionTo=function(a){return this.calcDirection(a)},a.prototype.calcDirectionBy=function(a){return a.calcDirection(this)},a.prototype.getDirectionCost=function(a){return b.GridNode.calcDirectionCost(this.direction,a)},a.prototype.getCost=function(a){var b,c;return b=this.weight,c=a.calcDirection(this),b+=a.getDirectionCost(c),(!this.visited||a.g+b<this.g)&&(this.direction=c),b},a.prototype.isWall=function(){return 0===this.weight},a}(),b.GridNode.calcDirection=function(a,b){var c;return c=0,a.x===b.x?(a.y>b.y&&(c=0),a.y<b.y&&(c=3)):a.x>b.x?a.y===b.y?c=a.x%2===0?5:4:a.y>b.y?c=5:a.y<b.y&&(c=4):a.x<b.x&&(a.y===b.y?c=a.x%2===0?1:2:a.y>b.y?c=1:a.y<b.y&&(c=2)),c},b.GridNode.calcDirectionCost=function(a,b){return Math.abs(3-Math.abs((b-a-3)%6))}}.call(this),function(){var a,b;b=nz.system.character.directions,a=nz.system.character.action_cost,tm.define("nz.Character",{init:function(a){null==a&&(a={}),this.$extend({name:"テストキャラクター",spriteSheet:"character_001",team:"teamA",ai:{name:"SampleAI",src:"nz/ai/SampleAI.js"},hp:10,sp:10,ap:6,mapx:-1,mapy:-1,direction:0,move:{speed:300},weapon:{height:48,width:12,rotation:{start:0,end:120,anticlockwise:!1},speed:600},shot:{rotation:{start:0,end:-120,anticlockwise:!0},distance:256,speed:100},commands:[]}.$extend(a))},_command:function(a){return null==a&&(a=this.commands.length-1),null==this.commands[a]&&(this.commands[a]={},this.clearAction(a)),this.commands[a]},createAiInfo:function(a){var b;return b={name:this.name,hp:this.hp,sp:this.sp,ap:this.ap,mapx:this.mapx,mapy:this.mapy,direction:this.direction,team:this.team,move:JSON.parse(JSON.stringify(this.move)),weapon:JSON.parse(JSON.stringify(this.weapon)),shot:JSON.parse(JSON.stringify(this.shot))},nz.Character(b)},clearAction:function(a){var b;b=this._command(a),b.attack=!1,b.actions=[],b.cost=0},clearMoveAction:function(b){var c;c=this._command(b),c.actions=[],c.cost=0,this.isAttackAction(b)&&(c.cost+=a.attack)},clearShotAction:function(b){var c,d,e,f,g,h;for(e=this._command(b),d=[],h=e.actions,f=0,g=h.length;g>f;f++)c=h[f],null!=c.shot&&(e.cost+=a.shot),d.push(c);e.actions=d},getActionCost:function(a){return this._command(a).cost},getRemnantAp:function(a){return this.ap-this.getActionCost(a)},addMoveCommand:function(a,c){var d,e,f,g,h,i,j,k,l,m,n;for(e=this._command(a),g=this.direction,n=e.actions,h=0,j=n.length;j>h;h++)d=n[h],null!=d.rotate&&(g=d.rotate.direction);for(l=e.cost,f=0,i=0,k=c.length;k>i;i++)m=c[i],g!==m.direction&&(this.addRotateCommand(a,g,b[g].rotateIndex[m.direction]),g=m.direction),m.speed=this.move.speed,e.actions.push({move:m}),f=m.cost;return e.cost=l+f,this},addRotateCommand:function(b,c,d){var e,f,g;for(e=this._command(b),b=f=0,g=d;g>=0?g>=f:f>=g;b=g>=0?++f:--f)0!==b&&(e.actions.push({rotate:{direction:(c+b+6)%6,speed:this.move.speed}}),e.cost+=a.rotate);return this},setAttackCommand:function(b,c){var d;return null==c&&(c=!0),this.ap>=a.attack&&(d=this._command(b),d.attack!==c&&(c?d.cost+=a.attack:d.cost-=a.attack,d.attack=c)),this},addShotCommand:function(b,c){var d;return d=this._command(b),d.actions.push({shot:{rotation:c,distance:this.shot.distance,speed:this.shot.speed}}),d.cost+=a.shot,this},isShotAction:function(a){var b,c,d,e,f;for(c=this._command(a),f=c.actions,d=0,e=f.length;e>d;d++)if(b=f[d],null!=b.shot)return!0;return!1},isAttackAction:function(a){var b;return b=this._command(a),b.attack},isMoveAction:function(a){var b,c,d,e,f;for(c=this._command(a),f=c.actions,d=0,e=f.length;e>d;d++)if(b=f[d],null!=b.move)return!0;return!1}})}.call(this),function(){var a,b;b=nz.system.map.chip.width,a=nz.system.map.chip.height,tm.define("nz.SpriteBattleMap",{superClass:tm.display.CanvasElement,init:function(c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;for(this.superInit(),this._chips=[],this._blinks=[],this._activeBlinks=[],this.characterSprites=[],this.map=tm.asset.Manager.get(c).data,this.graph=new nz.Graph({mapdata:this.map,chipdata:tm.asset.Manager.get("chipdata").data}),this.width=this.map.width*b,this.height=this.map.height*a,m=f=0,o=this.map.width;o>=0?o>f:f>o;m=o>=0?++f:--f)for(e=m%2!==0?this.map.height:this.map.width-1,n=g=0,p=e;p>=0?p>g:g>p;n=p>=0?++g:--g)this._initMapChip(m,n);for(this.cursor=this._createCursor().addChildTo(this),r=this,q=this._chips,h=0,j=q.length;j>h;h++)for(l=q[h],i=0,k=l.length;k>i;i++)d=l[i],d.on("pointingover",function(){return r.cursor.x=this.x,r.cursor.y=this.y});this.on("battleSceneStart",function(a){this.cursor.visible=!1}),this.on("battleSceneEnd",function(a){return this.cursor.visible=!0})},findCharacter:function(a,b){var c,d,e,f,g;for(g=[],f=this.characterSprites,d=0,e=f.length;e>d;d++)c=f[d],c.mapx===a&&c.mapy===b&&g.push(c);return g},findCharacterGhost:function(a,b){var c,d,e,f,g,h,i;for(i=[],f=this.characterSprites,d=0,e=f.length;e>d;d++)c=f[d],(null!=(g=c.ghost)?g.mapx:void 0)===a&&(null!=(h=c.ghost)?h.mapy:void 0)===b&&i.push(c.ghost);return i},_createCursor:function(){var c;return c=tm.display.Shape({width:b,height:a,strokeStyle:"red",lineWidth:3,visible:!1}),c._render=function(){return this.canvas.strokeRect(0,0,this.width,this.height)},c.render(),c},_dispatchMapChipEvent:function(a){var b;b=tm.event.Event("map."+a.type),b.app=a.app,b.pointing=a.pointing,b.mapx=this.mapx,b.mapy=this.mapy,b.app.currentScene.dispatchEvent(b)},_initMapChip:function(c,d){var e,f,g,h,i,j,k,l;j=b,h=a,k=c*j+.5*j,l=d*h+.5*h,c%2===0&&(l+=.5*h),i=this.graph.grid[c][d],g=i.frame,f=tm.display.Sprite("map_chip",j,h).addChildTo(this).setPosition(k,l).setFrameIndex(g).setInteractive(!0).setBoundingType("rect").on("pointingstart",this._dispatchMapChipEvent).on("pointingover",this._dispatchMapChipEvent).on("pointingout",this._dispatchMapChipEvent).on("pointingend",this._dispatchMapChipEvent),f.mapx=c,f.mapy=d,null!=i.object&&tm.display.Sprite("map_object",j,2*h).setOrigin(.5,.75).addChildTo(f).setFrameIndex(i.object.frame),e=tm.display.RectangleShape({width:j,height:h,strokeStyle:"white",fillStyle:"white"}).addChildTo(this).setPosition(k,l).setInteractive(!0).setAlpha(0).setVisible(!1),null==this._chips[c]&&(this._chips[c]=[]),this._chips[c][d]=f,null==this._blinks[c]&&(this._blinks[c]=[]),this._blinks[c][d]=e},blink:function(a,b){var c,d;c=null!=(d=this._blinks[a])?d[b]:void 0,null!=c&&(c.visible=!0,c.tweener.clear().fade(.5,300).fade(.1,300).setLoop(!0),this._activeBlinks.push(c))},clearBlink:function(){var a,b,c,d;for(d=this._activeBlinks,b=0,c=d.length;c>b;b++)a=d[b],a.visible=!1,a.setAlpha(0),a.tweener.clear();this._activeBlinks.clear()},isBlink:function(a,b){return this._blinks[a][b].visible},getMapChip:function(a,b){return this._chips[a][b]}})}.call(this),function(){var a,b,c;c=nz.system.map.chip.width,b=nz.system.map.chip.height,a=nz.system.character.directions,tm.define("nz.SpriteCharacter",{superClass:tm.display.AnimationSprite,init:function(a,b){this.index=a,this.character=b,this.superInit(this.character.spriteSheet),this.checkHierarchy=!0,this.ghost=null,this.body=tm.display.Shape({width:this.width,height:this.height}).addChildTo(this),this.weapon=tm.display.RectangleShape({width:this.character.weapon.height,height:this.character.weapon.width,strokeStyle:"black",fillStyle:"red"}).addChildTo(this.body).setOrigin(0,.5).setVisible(!1),this.weapon.checkHierarchy=!0,this.weapon.on("enterframe",this._enterframeWeapon.bind(this)),this.setMapPosition(this.character.mapx,this.character.mapy),this.setDirection(this.character.direction),this.on("battleSceneStart",function(){this.clearGhost()}),this.on("battleSceneEnd",function(){}),this.on("battleTurnStart",function(a){this.startAction(a.turn),this._weaponHitFlag=[]}),this.on("battleTurnEnd",function(a){this.update=null,this.attack=!1}),this.on("hitWeapon",function(a){this._hitWeapon(a.owner)}),this.on("hitBallet",function(a){this._hitBallet(a.owner,a.ballet)})},isGhost:function(){return.5===this.alpha},hasGhost:function(){return null!==this.ghost},createGhost:function(a,b,c){return this.clearGhost(),this.ghost=nz.SpriteCharacter(this.index,this.character).setAlpha(.5).setMapPosition(b,c).setDirection(a),this.ghost},clearGhost:function(){null!=this.ghost&&(this.ghost.remove(),this.ghost=null)},setMapPosition:function(a,d){var e,f;return this.mapx=a,this.mapy=d,f=c,e=b,this.x=this.mapx*f+f*this.originX,this.y=this.mapy*e+e*this.originY,this.mapx%2===0&&(this.y+=.5*e),this},setDirection:function(b){var c;return this.direction=b,c=a[this.direction],this.body.rotation=c.rotation,this.gotoAndPlay(c.name),this},updateBattle:function(){var a,b,c,d,e,f;for(f=this.getRoot(),e=f.characterSprites,b=c=0,d=e.length;d>c;b=++c)a=e[b],this.index!==b&&this._updateAttack(a)},calcRotation:function(a){var b;return b=Math.radToDeg(Math.atan2(a.y-this.y,a.x-this.x))-this.body.rotation,b>180?b-=360:-180>b&&(b+=360),b},checkDirection:function(a){var b,c,d,e,f,g,h,i,j;return e=a.r,j=a.start,d=a.end,b=a.anticlockwise,c=a.callback,null==e&&(e=this.calcRotation(a)),f=b?d:j,g=b?j:d,i=!1,i=g>f?e>=f&&g>=e:e>=f||g>=e,null!=c&&(i||(f>e&&(h=f),e>g&&(h=g)),c(i,h)),i},_checkAttackDirection:function(a){return a.x-=this.width/2,a.y-=this.height/2,this.checkDirection(a)?!0:(a.x+=this.width,this.checkDirection(a)?!0:(a.y+=this.height,this.checkDirection(a)?!0:(a.x-=this.width,this.checkDirection(a)?!0:!1)))},_updateAttack:function(a){var b,c,d;this.attack&&this.character.team!==a.character.team&&(b=this.character.weapon,c=a.position.distance(this.position),c<b.height+this.body.width/2&&(d=a.position.clone().$extend(b.rotation),this._checkAttackDirection(d)&&(this.attackAnimation(),this.attack=!1)))},_enterframeWeapon:function(a){var b,c,d,e,f,g;if(this.weapon.visible)for(g=this.getRoot(),f=g.characterSprites,c=d=0,e=f.length;e>d;c=++d)b=f[c],this.index===c||this._weaponHitFlag[c]||this._isHitWeapon(b)&&(b.flare("hitWeapon",{owner:this}),this._weaponHitFlag[c]=!0)},_isHitWeapon:function(a){var b,c,d,e;for(e=b=16,c=this.weapon.width;c>b;e=b+=8)if(d=tm.geom.Vector2(0,0),d.setDegree(this.weapon.rotation+this.body.rotation,e),d=this.localToGlobal(d),a.isHitPoint(d.x,d.y))return!0;return!1},startAction:function(a){var b,c,d,e,f;if(this.tweener.clear(),this.move=!1,this.action=!0,this.mapx=this.character.mapx,this.mapy=this.character.mapy,this.direction=this.character.direction,c=this.character.commands[a],null!=c)for(this.attack=c.attack,f=c.actions,d=0,e=f.length;e>d;d++)b=f[d],null!=b.shot&&this._setShotAction(b.shot),null!=b.move&&this._setMoveAction(b.move),null!=b.rotate&&this._setRotateAction(b.rotate),this.attack&&this.tweener.call(this.updateBattle,this,[]);this.tweener.call(this._endAction,this,[])},applyPosition:function(){this.character.mapx=this.mapx,this.character.mapy=this.mapy,this.character.direction=this.direction},_endAction:function(){this.applyPosition(),this.move=!1,this.action=!1,this.attack&&(this.updateBattle(),this.update=this.updateBattle),this.tweener.clear()},isMove:function(){return this.move},isStop:function(){return!this.move},_setShotAction:function(a){this.tweener.call(this.shotAnimation,this,[a])},_setMoveAction:function(a){var d,e,f,g,h;this.move=!0,this.mapx=a.mapx,this.mapy=a.mapy,e=a.speed,f=c,d=b,g=this.mapx*f+f*this.originX,h=this.mapy*d+d*this.originY,this.mapx%2===0&&(h+=.5*d),this.tweener.move(g,h,e)},_setBackAction:function(a){},_setRotateAction:function(a){var b,c;return b=a.direction,c=a.speed,this.tweener.wait(c),this.tweener.call(this.directionAnimation,this,[b])},directionAnimation:function(a){return this.setDirection(a)},attackAnimation:function(){var a,b,c;return a=this.action,this.action=!0,c=function(){return this.weapon.visible=!1,this.weapon.rotation=0,this.tweener.play(),this.action=a},this.tweener.pause(),b=this.character.weapon,this.weapon.visible=!0,this.weapon.rotation=b.rotation.start,this.weapon.tweener.clear().wait(50).rotate(b.rotation.end,b.speed).call(c,this,[])},shotAnimation:function(a){var b,c,d,e,f,g,h,i,j,k,l;return h=a.rotation,e=a.distance,j=a.speed,i=this.getRoot(),d=i.mapSprite.globalToLocal(this.localToGlobal(this.body.position)),c=tm.display.CircleShape({x:d.x,y:d.y,width:10,height:10}).addChildTo(i.mapSprite),b=Math.degToRad(h),k=e*Math.cos(b)+d.x,l=e*Math.sin(b)+d.y,j=j*e/32,f={ballet:c,owner:this},g=function(){return c.remove(),i.flare("removeBallet",f)},c.tweener.move(k,l,j).call(g,this,[]),c.on("collisionenter",function(a){return a.other.flare("hitBallet",f),c.tweener.clear().call(g,this,[])}),i.flare("addBallet",f)},_hitBallet:function(a,b){console.log("hit ballet "+this.character.name)},_hitWeapon:function(a){console.log("hit weapon "+this.character.name)}})}.call(this),function(){tm.define("nz.SpriteStatus",{superClass:tm.display.CanvasElement,init:function(a){var b;return this.index=a.index,this.character=a.character,this.detail=a.detail,this.superInit(),this.setOrigin(0,0),this.width=160,this.height=80,this.alpha=1,this.boundingType="rect",this.interactive=!0,this.checkHierarchy=!0,this.bgColor="blanchedalmond",b="gray",this.fromJSON({children:{bg:{type:"RoundRectangleShape",width:this.width,height:this.height,strokeStyle:"black",fillStyle:this.bgColor,lineWidth:1,shadowBlur:1,shadowOffsetX:2,shadowOffsetY:2,shadowColor:"gray",originX:this.originX,originY:this.originY},name:{type:"Label",text:this.character.name,fillStyle:"black",align:"left",baseline:"top",x:8,y:10,originX:this.originX,originY:this.originY,fontSize:8},action:{type:"Label",fillStyle:"black",align:"left",baseline:"top",x:8,y:20,originX:this.originX,originY:this.originY,fontSize:8},hpGauge:{type:"tm.ui.FlatGauge",x:8,y:32,width:this.width-16,height:4,originX:this.originX,originY:this.originY,borderWidth:1,color:"blue",bgColor:this.bgColor,borderColor:b},mpGauge:{type:"tm.ui.FlatGauge",x:8,y:40,width:this.width-16,height:4,originX:this.originX,originY:this.originY,borderWidth:1,color:"green",bgColor:this.bgColor,borderColor:b},spGauge:{type:"tm.ui.FlatGauge",x:8,y:48,width:this.width-16,height:4,originX:this.originX,originY:this.originY,borderWidth:1,color:"Cyan",bgColor:this.bgColor,borderColor:b}}}),this.on("refreshStatus",function(a){var b,c,d;return d=a.turn,c="行動: ",this.detail?(b=[],this.character.isAttackAction(d)&&b.push("Attack"),this.character.isShotAction(d)&&b.push("Shot"),this.character.isMoveAction(d)&&b.push("Move"),c+=b.join(" & "),c+=" ("+(this.character.ap-this.character.getActionCost(d))+")"):c+="？？？",this.action.text=c})}})}.call(this),function(){var a,b;b=nz.system.screen.width,a=nz.system.screen.height,tm.define("nz.SceneBase",{superClass:tm.app.Scene,init:function(){this.superInit()},fireAll:function(a,b){null==b&&(b={}),"string"==typeof a&&(a=tm.event.Event(a),a.app=this.app,a.$extend(b)),this._dispatchEvent(a)},_dispatchEvent:function(a,b){var c,d,e,f;for(null==b&&(b=this),b.hasEventListener(a.type)&&b.fire(a),f=b.children,d=0,e=f.length;e>d;d++)c=f[d],this._dispatchEvent(a,c)},openMenuDialog:function(c){var d,e,f,g;return g={screenWidth:b,screenHeight:a}.$extend(c),f=function(){var a,b,c,d;for(c=g.menu,d=[],a=0,b=c.length;b>a;a++)e=c[a],null!=e.func&&d.push(e.func);return d}(),g.menu=function(){var a,b,c,d;for(c=g.menu,d=[],a=0,b=c.length;b>a;a++)e=c[a],null!=e.name&&d.push(e.name);return d}(),d=tm.ui.MenuDialog(g),d.on("menuclosed",function(a){var b;return null!=(b=f[a.selectIndex])?b.call(null,a.selectIndex):void 0}),d.box.setStrokeStyle(nz.system.dialog.strokeStyle),d.box.setFillStyle(nz.system.dialog.fillStyle),this.app.pushScene(d),d},description:function(c){return this._description||(this._description=tm.display.Label("",14).addChildTo(this).setAlign("center").setBaseline("middle").setPosition(b/2,a-10)),this._description.text=c}})}.call(this),function(){tm.define("nz.SceneTitleMenu",{superClass:tm.ui.MenuDialog,init:function(){var a,b;b=[{name:"New Game",desctiption:"新しいゲームをはじめる",callback:this._new_game},{name:"Load Game",desctiption:"保存したゲームをはじめる",callback:this._load_game},{name:"Option",desctiption:"ゲームオプション",callback:this._option},{name:"Debug",desctiption:"デバック",callback:this._debug_game}],this.superInit({title:nz.system.title,screenWidth:nz.system.screen.width,screenHeight:nz.system.screen.height,menu:function(){var c,d,e;for(e=[],c=0,d=b.length;d>c;c++)a=b[c],e.push(a.name);return e}(),menuDesctiptions:function(){var c,d,e;for(e=[],c=0,d=b.length;d>c;c++)a=b[c],e.push(a.desctiption);return e}()}),this.box.setStrokeStyle(nz.system.dialog.strokeStyle),this.box.setFillStyle(nz.system.dialog.fillStyle),this.index=0,this.on("menuselected",function(a){return this.index=a.selectIndex}),this.on("exit",function(a){return b[this.index].callback.call(this,a)}),this.on("enter",function(a){return this.app.pushScene(tm.game.TitleScene({title:nz.system.title}))})},_new_game:function(){this.app.pushScene(nz.SceneBattle({mapId:1,controlTeam:["teamA"],characters:[nz.Character({name:"キャラクター1",team:"teamA"}),nz.Character({name:"キャラクター2",team:"teamA"}),nz.Character({name:"キャラクター3",team:"teamA"}),nz.Character({name:"キャラクター4",team:"teamB"}),nz.Character({name:"キャラクター5",team:"teamB"}),nz.Character({name:"キャラクター6",team:"teamB"})]}))},_load_game:function(){console.log("load game")},_option:function(){console.log("option")},_debug_game:function(){this.app.pushScene(nz.SceneBattle({mapId:0,controlTeam:["teamA"],characters:[nz.Character({name:"キャラクター1",team:"teamA"}),nz.Character({name:"キャラクター2",team:"teamA"}),nz.Character({name:"キャラクター3",team:"teamA"}),nz.Character({name:"キャラクター4",team:"teamB"}),nz.Character({name:"キャラクター5",team:"teamB"}),nz.Character({name:"キャラクター6",team:"teamB"})]}))}})}.call(this),function(){var a,b,c,d;d=nz.system.screen.width,c=nz.system.screen.height,b=nz.system.character.directions,a=nz.system.character.action_cost,tm.define("nz.SceneBattle",{superClass:nz.SceneBase,init:function(a){this.mapId=a.mapId,this.characters=a.characters,this.controlTeam=a.controlTeam,this.superInit(),this.mapName="map_"+(""+this.mapId).paddingLeft(3,"0"),this._selectCharacterIndex=0,this.data={turn:0},this.on("enter",this.load.bind(this))},load:function(){var a,b,e,f,g,h,i;for(g=!0,a={},tm.asset.Manager.contains(this.mapName)||(a[this.mapName]="data/"+this.mapName+".json",g=!1),h=this.characters,e=0,f=h.length;f>e;e++)b=h[e],tm.asset.Manager.contains(b.ai.name)||(a[b.ai.name]=b.ai.src,g=!1);g?this.setup():(i=tm.game.LoadingScene({assets:a,width:d,height:c,autopop:!0}),i.on("load",this.setup.bind(this)),this.app.pushScene(i))},setup:function(){var a,b,e,f,g,h,i,j;for(h=this,this.mapSprite=nz.SpriteBattleMap(this.mapName).addChildTo(this),this.mapSprite.x=(d-this.mapSprite.width)/2,this.mapSprite.y=(c-this.mapSprite.height)/2,this.status=tm.display.CanvasElement().addChildTo(this),i=j=0,g=this.characters,b=e=0,f=g.length;f>e;b=++e)a=g[b],this.characterSprites.push(nz.SpriteCharacter(b,a).setVisible(!1).addChildTo(this.mapSprite));this.characterSprites[0].setMapPosition(0,0),this.characterSprites[0].applyPosition(),this.characterSprites[0].setVisible(!0),this.characterSprites[0].character.move.speed=150,this.on("map.pointingend",this.mapPointingend),this.one("enterframe",function(){return this._startInputPhase()}),this.refreshStatus()},mapPointingend:function(a){var b,c,d,e,f;e=this.characters[0],b=e.direction,c=e.mapx,d=e.mapy,f=this.mapSprite.graph.searchRoute(b,c,d,a.mapx,a.mapy),this.selectCharacter.addMoveCommand(this.turn,f),this._pushScene(nz.SceneBattleTurn({start:this.turn,end:this.turn,mapSprite:this.mapSprite})),this.one("resume",function(){return this._startInputPhase()})},refreshStatus:function(){this.fireAll("refreshStatus",{turn:this.turn})},activeStatus:function(a){this.status.addChild(a)},blinkCharacter:function(a){var b;b=this.characterSprites[a],this.mapSprite.clearBlink(),this.mapSprite.blink(b.mapx,b.mapy),b.hasGhost()&&this.mapSprite.blink(b.ghost.mapx,b.ghost.mapy)},_pushScene:function(a){this.one("pause",function(){return this.mapSprite.addChildTo(a)}),this.one("resume",function(){return this.mapSprite.addChildTo(this)}),this.mapSprite.remove(),this.app.pushScene(a)},_commandScene:function(a,b){var c;this.refreshStatus(),c=this.selectCharacterSprite,this._selectGhost&&(c=this.selectCharacterSprite.ghost),this._pushScene(a({turn:this.turn,target:c,callback:b,mapSprite:this.mapSprite})),this.one("resume",this._checkCommandConf.bind(this))},_openMainMenu:function(){this.openMenuDialog({title:"Command?",menu:[{name:"Next Turn",func:this._openCommandConf.bind(this)},{name:"Option",func:function(a){}},{name:"Exit Game",func:this._exitGame.bind(this)},{name:"Close Menu"}]})},_openCharacterSelectMenu:function(a){var b,c,d,e;for(d=[],b=0,c=a.length;c>b;b++)e=a[b],d.push({name:e.character.name,func:function(b){return this._openCharacterMenu(a[b])}.bind(this)});d.push({name:"Close Menu"}),this.openMenuDialog({title:"Select Character",menu:d})},_openCharacterMenu:function(b){var c,d,e,f,g,h,i,j,k,l;for(this._selectCharacterIndex=b.index,this._selectGhost=b.isGhost(),i=this.status.children,e=0,f=i.length;f>e;e++)j=i[e],j.index===b.index&&this.activeStatus(j);g=[],k=this.selectCharacter,c=k.getActionCost(this.turn),h=k.getRemnantAp(this.turn),(this._selectGhost||!this._selectGhost&&!b.hasGhost())&&(h>0&&(g.push({name:"Move",func:this._addMoveCommand.bind(this)}),g.push({name:"Direction",func:this._addRotateCommand.bind(this)})),h>=a.attack&&(d=k.isAttackAction(this.turn),l=k.isShotAction(this.turn),d||l||(g.push({name:"Attack",func:this._addAttackCommand.bind(this)}),g.push({name:"Shot",func:this._addShotCommand.bind(this)})))),c>0&&g.push({name:"Reset Action",func:this._resetAction.bind(this)}),g.push({name:"Close Menu"}),this.openMenuDialog({title:k.name,menu:g})},_openCommandConf:function(){this.openMenuDialog({title:"Start Battle?",menu:[{name:"Yes",func:this._startBattlePhase.bind(this)},{name:"No"}]})},_checkCommandConf:function(){var a,b,c,d;for(d=this.characters,b=0,c=d.length;c>b;b++)if(a=d[b],this.controlTeam.contains(a.team)&&a.getRemnantAp(this.turn)>0)return;this._openCommandConf()},_exitGame:function(){this.app.replaceScene(nz.SceneTitleMenu())},_startInputPhase:function(){var a,b,c,d,e,f;for(this.mapSprite.cursor.visible=!0,this.data.turn+=1,b=function(){var b,c,d,e;for(d=this.characters,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(a.createAiInfo());return e}.call(this),c=d=0,e=b.length;e>d;c=++d)a=b[c],this.controlTeam.contains(a.team)||(null!=(f=nz.system.ai[a.ai.name])&&f.setupAction({character:a,characters:b,graph:this.mapSprite.graph,turn:this.turn}),this.characters[c].commands[this.turn]=a.commands[this.turn]);return this.refreshStatus()},_startBattlePhase:function(){this.refreshStatus(),this._pushScene(nz.SceneBattleTurn({start:this.turn,end:this.turn,mapSprite:this.mapSprite})),this.one("resume",function(){return this._startInputPhase()})},_addMoveCommand:function(){this._commandScene(nz.SceneBattleMoveCommand,function(a){var b;this.selectCharacter.addMoveCommand(this.turn,a),a.length>0&&(b=a[a.length-1],this.selectCharacterSprite.createGhost(b.direction,b.mapx,b.mapy).addChildTo(this.mapSprite)),this.refreshStatus()}.bind(this))},_addAttackCommand:function(){var a,b;a=this.selectCharacter,a.setAttackCommand(this.turn),b=this.selectCharacterSprite,b.hasGhost()||b.isGhost()||b.createGhost(b.direction,b.mapx,b.mapy).addChildTo(this.mapSprite),this.refreshStatus(),a.getRemnantAp(this.turn)>0?(this._selectGhost=!0,this.one("enterframe",this._addMoveCommand)):this._checkCommandConf()},_addShotCommand:function(){this._commandScene(nz.SceneBattleShotCommand,function(a){var b,c;b=this.selectCharacter,c=this.selectCharacterSprite,b.addShotCommand(this.turn,a),c.hasGhost()||c.isGhost()||c.createGhost(c.direction,c.mapx,c.mapy).addChildTo(this.mapSprite),this.refreshStatus(),b.getRemnantAp(this.turn)>0&&(this._selectGhost=!0,this.one("enterframe",this._addMoveCommand))}.bind(this))},_addRotateCommand:function(){this._commandScene(nz.SceneBattleDirectionCommand,function(a,c){var d,e,f;e=this.selectCharacter,f=this.selectCharacterSprite,e.addRotateCommand(this.turn,a,b[a].rotateIndex[c]),f.hasGhost()?f.ghost.setDirection(c):(d=f,d.createGhost(c,d.mapx,d.mapy).addChildTo(this.mapSprite)),this.refreshStatus(),e.getRemnantAp(this.turn)>0&&(this._selectGhost=!0,this.one("enterframe",this._addMoveCommand))}.bind(this))},_resetAction:function(){this.selectCharacter.clearAction(),this.selectCharacterSprite.clearGhost()}}),nz.SceneBattle.prototype.getter("characterSprites",function(){return this.mapSprite.characterSprites}),nz.SceneBattle.prototype.getter("selectCharacterSprite",function(){return this.characterSprites[this._selectCharacterIndex]}),nz.SceneBattle.prototype.getter("selectCharacter",function(){return this.selectCharacterSprite.character}),nz.SceneBattle.prototype.getter("turn",function(){return this.data.turn})}.call(this),function(){var a,b;b=nz.system.MESSAGES,a=nz.system.DIRECTION_NUM,tm.define("nz.SceneBattlePosition",{superClass:nz.SceneBase,init:function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;for(this.superInit(),this.mapSprite=a.mapSprite,this.controlTeam=a.controlTeam,this.otherTeam=[],this.teamArea={},this.members={},c=0,p=this.mapSprite.characterSprites,f=0,i=p.length;i>f;f++)d=p[f],t=d.character.team,null==this.members[t]&&(this.members[t]=[],this.teamArea[t]=this.mapSprite.map.start.area[c].clone(),this.controlTeam.contains(t)||this.otherTeam.push(t),c+=1),this.members[t].push(d);for(q=this.otherTeam,g=0,j=q.length;j>g;g++)for(t=q[g],b=this.teamArea[t],n=function(){var a,b,c,d;for(c=this.members[t],d=[],a=0,b=c.length;b>a;a++)l=c[a],d.push(l.character);return d}.call(this),r=this.members[t],e=h=0,k=r.length;k>h;e=++h)m=r[e],d=m.character,o=null!=(s=nz.system.ai[d.ai.name])?s.setupBattlePosition({character:d,members:n,area:b}):void 0,null==o&&(o=b[e]),this._setBattlePosition(m,o[0],o[1]),m.applyPosition();this.on("map.pointingover",this._mapPointingover),this.on("map.pointingend",this._mapPointingend),this.on("enter",this._start)},_test:function(a){var b,c,d,e,f,g;for(this.mapSprite.cursor.visible=!0,this.mapSprite.clearBlink(),f=b=0,d=this.mapSprite.map.width;d>=0?d>b:b>d;f=d>=0?++b:--b)for(g=c=0,e=this.mapSprite.map.height;e>=0?e>c:c>e;g=e>=0?++c:--c)nz.system.ai.SampleAI.calcDistance({x:a.mapx,y:a.mapy},{x:f,y:g})<=3&&this.mapSprite.blink(f,g)},_start:function(){var a,c,d,e;for(e=this.mapSprite.characterSprites,c=0,d=e.length;d>c;c++)if(a=e[c],!a.visible)return this._selectCharacter(a),void this.description(b.battle.position.setiing.format({name:a.character.name}))},_end:function(){var b,c,d,e,f;for(e=this.mapSprite.map.width/2,f=this.mapSprite.characterSprites,c=0,d=f.length;d>c;c++)b=f[c],b.visible=!0,b.mapy<e?(b.character.direction=a.DOWN,b.setDirection(a.DOWN)):(b.character.direction=a.UP,b.setDirection(a.UP));this.mapSprite.clearBlink(),this.one("enterframe",function(){return this.app.popScene()})},_openCharacterMenu:function(){var a,b,c,d,e,f,g,h,i,j;for(this.mapSprite.clearBlink(),this.mapSprite.cursor.visible=!1,b=[],g=[],h=this.controlTeam,c=0,e=h.length;e>c;c++)for(j=h[c],i=this.members[j],d=0,f=i.length;f>d;d++)a=i[d],a.visible||(b.push(a),g.push({name:a.character.name,func:function(a){return this._selectCharacter(b[a])}.bind(this)}));return this.openMenuDialog({title:"Character",menu:g})},_selectCharacter:function(a){var b,c,d,e,f;for(this.character=a,this.mapSprite.clearBlink(),e=this.teamArea[this.character.character.team],f=[],b=0,c=e.length;c>b;b++)d=e[b],f.push(0===this.mapSprite.findCharacter(d[0],d[1]).length?this.mapSprite.blink(d[0],d[1]):void 0);return f},_setBattlePosition:function(b,c,d){b.setMapPosition(c,d),b.setDirection(b.mapy<this.mapSprite.map.width/2?a.DOWN:a.UP)},_mapPointingover:function(a){this.mapSprite.cursor.visible=!0,this.character.visible=!0,this._setBattlePosition(this.character,a.mapx,a.mapy),this.character.applyPosition()},_mapPointingend:function(a){var b,c,d,e,f,g,h,i;if(this.mapSprite.isBlink(a.mapx,a.mapy)){for(this._mapPointingover(a),g=this.controlTeam,c=0,e=g.length;e>c;c++)for(i=g[c],h=this.members[i],d=0,f=h.length;f>d;d++)if(b=h[d],!b.visible)return void this._start();this._end()}}})}.call(this),function(){
tm.define("nz.SceneBattleMoveCommand",{superClass:tm.app.Scene,init:function(a){return this.superInit(),this.turn=a.turn,this.target=a.target,this.callback=a.callback,this.mapSprite=a.mapSprite,this.on("map.pointingover",this._over),this.on("map.pointingend",this._end)},searchRoute:function(a,b){var c,d,e,f;return f=this.target,c=f.direction,d=f.mapx,e=f.mapy,this.mapSprite.graph.searchRoute(c,d,e,a,b)},commandAp:function(){return this.target.character.ap-this.target.character.getActionCost(this.turn)},_end:function(a){this.mapSprite.isBlink(a.mapx,a.mapy)&&this.callback(this.searchRoute(a.mapx,a.mapy)),this.mapSprite.clearBlink(),this.one("enterframe",function(){return this.app.popScene()})},_over:function(a){var b,c,d,e,f,g;for(this.mapSprite.clearBlink(),b=this.commandAp(),g=this.searchRoute(a.mapx,a.mapy),f=[],c=0,d=g.length;d>c;c++)e=g[c],e.cost<=b&&f.push(this.mapSprite.blink(e.mapx,e.mapy));return f}})}.call(this),function(){tm.define("nz.SceneBattleShotCommand",{superClass:tm.app.Scene,init:function(a){return this.superInit(),this.turn=a.turn,this.target=a.target,this.callback=a.callback,this.mapSprite=a.mapSprite,this.costa=this.target.character.getActionCost(this.turn),this.on("map.pointingend",this._pointEnd),this._createPointer()},update:function(a){this._movePointer(a.pointing)},_pointStart:function(a){this._movePointer(a.pointing)},_pointMove:function(a){this._movePointer(a.pointing)},_pointEnd:function(a){this._setupCommand(),this._removePointer(),this._endScene()},_setupCommand:function(){null!=this.pointer&&this.callback(this.pointer.rotation)},_endScene:function(){this.one("enterframe",function(){return this.app.popScene()})},_createPointer:function(){this.pointer=tm.display.Shape({width:10,height:10}).addChildTo(this.mapSprite).setPosition(this.target.x,this.target.y),tm.display.CircleShape({x:40,width:10,height:10,fillStyle:"blue"}).addChildTo(this.pointer),this.pointer.rotation=this.target.body.rotation},_removePointer:function(){null!=this.pointer&&(this.pointer.remove(),this.pointer=null)},_movePointer:function(a){var b,c;null!=this.pointer&&(b=this.mapSprite.globalToLocal(a),c=this.target.character.shot.rotation,this.target.checkDirection({x:b.x,y:b.y,start:c.start,end:c.end,anticlockwise:c.anticlockwise,callback:function(a,c){var d,e,f;return a?(e=b.x-this.target.x,f=b.y-this.target.y,d=tm.geom.Vector2(e,f),c=Math.radToDeg(d.toAngle())):c+=this.target.body.rotation,this.pointer.rotation=c}.bind(this)}))}})}.call(this),function(){var a;a=nz.system.character.directions,tm.define("nz.SceneBattleDirectionCommand",{superClass:nz.SceneBattleShotCommand,init:function(a){return this.superInit(a),this._direction=null},_setupCommand:function(){null!=this._direction&&this.callback(this.target.direction,this._direction)},_movePointer:function(b){var c,d,e,f,g,h,i,j,k,l;if(null!=this.pointer)for(i=this.target.body.localToGlobal(tm.geom.Vector2(0,0)),k=b.x-i.x,l=b.y-i.y,j=tm.geom.Vector2(k,l),h=Math.radToDeg(j.toAngle()),e=f=0,g=a.length;g>f;e=++f)if(d=a[e],e>=0&&6>e&&d.rotation-30<h&&h<d.rotation+30&&(c=nz.GridNode.calcDirectionCost(this.target.direction,d.index),this.costa+c<=this.target.character.ap&&this._direction!==d.index))return this._direction=d.index,void(this.pointer.rotation=d.rotation)}})}.call(this),function(){tm.define("nz.SceneBattleTurn",{superClass:tm.app.Scene,init:function(a){var b,c;this.superInit(),this.mapSprite=a.mapSprite,c=a.start,b=a.end,this.startTuen=c,this.endTurn=b,this.turn=c,this.runing=!1,this._balletCount=0,this.on("enter",this._startScene),this.on("addBallet",this._addBallet),this.on("removeBallet",this._removeBallet)},_removeBallet:function(a){var b;return b=a.ballet,this._balletCount-=1},_addBallet:function(a){var b,c,d,e,f,g;for(b=a.ballet,f=a.owner,this._balletCount+=1,g=this.characterSprites,d=0,e=g.length;e>d;d++)c=g[d],c!==f&&b.collision.add(c)},_dispatchBattleEvent:function(a,b){var c,d,e,f;for(null==b&&(b=this),"string"==typeof a&&(a=tm.event.Event(a),a.app=this.app,a.turn=this.turn),b.hasEventListener(a.type)&&b.fire(a),f=b.children,d=0,e=f.length;e>d;d++)c=f[d],this._dispatchBattleEvent(a,c)},_startScene:function(){this._dispatchBattleEvent("battleSceneStart"),this._startTurn(this.startTuen)},_endScene:function(){this._dispatchBattleEvent("battleSceneEnd"),this.app.popScene()},_startTurn:function(a){this.turn=a,this._dispatchBattleEvent("battleTurnStart"),this.update=this.updateTurn},_endTurn:function(){this._dispatchBattleEvent("battleTurnEnd"),this.update=null},_isEnd:function(){return this.turn>=this.endTurn},_isEndAllCharacterAction:function(){var a,b,c,d,e;for(b=!1,e=this.characterSprites,c=0,d=e.length;d>c;c++)a=e[c],b|=a.action;return!b&&0===this._balletCount},updateTurn:function(){this._isEndAllCharacterAction()&&(this._endTurn(),this._isEnd()?this._endScene():this._startTurn(this.turn+1))}}),nz.SceneBattleTurn.prototype.getter("characterSprites",function(){return this.mapSprite.characterSprites})}.call(this),function(){tm.main(function(){var a,b,c;return c=nz.system.screen,b=nz.system.assets,a=tm.display.CanvasApp("#world"),a.resize(c.width,c.height),a.fitWindow(),a.background="gray",a.pushScene(tm.game.LoadingScene({assets:b,width:c.width,height:c.height}).on("load",function(){this.app.replaceScene(nz.SceneBattle({mapId:1,controlTeam:["teamA"],characters:[nz.Character({name:"キャラクター1",team:"teamA"})]}))})),a.run()})}.call(this);